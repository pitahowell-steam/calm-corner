<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kawaii Calm - PGCPS Sanctuary</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/react-native-web@0.19.6/dist/bundle.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    html, body, #app-root { height: 100%; width: 100%; overflow: hidden; margin: 0; padding: 0; font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", sans-serif; }
    #app-root { display: flex; }
  </style>
</head>
<body>
  <div id="app-root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;
    const { 
      Text, View, StyleSheet, TouchableOpacity, Animated, 
      SafeAreaView, ScrollView, TextInput, Dimensions, ImageBackground 
    } = ReactNative;

    const { width, height } = Dimensions.get('window');

    // Browser-based storage helper
    const AsyncStorage = {
      getItem: async (key) => window.localStorage.getItem(key),
      setItem: async (key, val) => window.localStorage.setItem(key, val),
    };

    // --- FULL DATA SET ---
    const SUGGESTED_BEFORE = ["Overwhelmed", "Disrespected", "Drained", "Hyped", "Stressed", "Frustrated"];
    const SUGGESTED_AFTER = ["Steady", "Stronger", "Relaxed", "Focused", "Better", "In Control"];

    const MICRO_MISSIONS = [
      { task: "Find 3 blue things in the room.", question: "What 3 blue things did you find?" },
      { task: "Notice your feet on the floor.", question: "Did the floor feel solid, cold, or warm?" },
      { task: "Identify one sound outside.", question: "What was the sound? Was it loud or quiet?" },
      { task: "Drop your shoulders heavy.", question: "How did it feel when the tension melted?" },
      { task: "Look left, then right.", question: "What is one tiny detail you never noticed before?" },
      { task: "Take one 'sip' of air.", question: "How does your chest feel when you empty it?" },
      { task: "Unclench your jaw.", question: "Does your face feel softer now?" },
      { task: "Find a texture nearby.", question: "What did you touch? Was it smooth or fuzzy?" }
    ];

    const REWARDS_POOL = [
      { id: 1, emoji: "üê¢", name: "Patience Turtle", message: "Slow and steady is a superpower." },
      { id: 2, emoji: "üê±", name: "Lucky Cat", message: "A friend to watch over your peace." },
      { id: 3, emoji: "üëü", name: "Running Shoes", message: "Moving your body helps clear your mind." },
      { id: 4, emoji: "‚òÄÔ∏è", name: "Golden Sun", message: "Light and fresh air can reset your mood." },
      { id: 5, emoji: "üìì", name: "Zen Journal", message: "Writing it down makes it easier to let go." },
      { id: 10, emoji: "‚òÅÔ∏è", name: "Happy Cloud", message: "Feelings pass by just like clouds." }
    ];

    const AFFIRMATIONS = [
      "I am proud of you for taking this time for yourself.",
      "You just gave your brain a much-needed break.",
      "Taking a breath is the first step to taking control.",
      "One breath at a time is enough."
    ];

    // --- ANIMATED COMPONENTS ---
    const TwinkleStar = () => {
      const opacity = useRef(new Animated.Value(Math.random())).current;
      const [pos] = useState({ top: Math.random() * height, left: Math.random() * width });
      useEffect(() => {
        const twinkle = () => {
          Animated.sequence([
            Animated.timing(opacity, { toValue: 0.2, duration: Math.random() * 2000 + 1000, useNativeDriver: false }),
            Animated.timing(opacity, { toValue: 1, duration: 1500, useNativeDriver: false }),
          ]).start(() => twinkle());
        };
        twinkle();
      }, []);
      return <Animated.View style={[styles.star, { top: pos.top, left: pos.left, opacity }]} />;
    };

    const PoppingItem = ({ item, onTouch }) => {
      const opacity = useRef(new Animated.Value(1)).current;
      const scale = useRef(new Animated.Value(1)).current;
      const handlePop = () => {
        onTouch(item.message);
        Animated.parallel([
          Animated.timing(opacity, { toValue: 0, duration: 150, useNativeDriver: false }),
          Animated.timing(scale, { toValue: 1.6, duration: 150, useNativeDriver: false })
        ]).start(() => {
          setTimeout(() => {
            scale.setValue(0);
            Animated.parallel([
              Animated.timing(opacity, { toValue: 1, duration: 400, useNativeDriver: false }),
              Animated.spring(scale, { toValue: 1, friction: 6, useNativeDriver: false })
            ]).start();
          }, 1200);
        });
      };
      return (
        <TouchableOpacity onPress={handlePop} activeOpacity={0.8}>
          <View style={styles.itemContainer}>
            <Animated.View style={[styles.popCircle, { opacity, transform: [{ scale }] }]} />
            <Text style={styles.rewardText}>{item.emoji}</Text>
          </View>
        </TouchableOpacity>
      );
    };

    // --- MAIN APP COMPONENT ---
    function App() {
      const [screen, setScreen] = useState('login'); 
      const [currentUser, setCurrentUser] = useState('');
      const [selectedScene, setSelectedScene] = useState({ id: 'garden', themeColor: '#FFB7B2' });
      const [inventory, setInventory] = useState([]);
      const [totalSessions, setTotalSessions] = useState(0);
      const [currentReward, setCurrentReward] = useState(null);
      const [currentMission, setCurrentMission] = useState(null);
      const [reflectionText, setReflectionText] = useState("");
      const [currentAffirmation, setCurrentAffirmation] = useState("");
      const [breathText, setBreathText] = useState("");
      const breathAnim = useRef(new Animated.Value(0.1)).current;
      const [beforeMood, setBeforeMood] = useState("");
      const [afterMood, setAfterMood] = useState("");
      const [activeMessage, setActiveMessage] = useState("Tap your items to ground yourself...");

      // Persistence
      const saveUserProgress = async (name, inv, tot) => {
        try {
          const data = JSON.stringify({ inventory: inv, totalSessions: tot });
          await AsyncStorage.setItem(`@kawaii_${name.toLowerCase()}`, data);
        } catch (e) {}
      };

      const loginUser = async (name) => {
        if (!name.trim()) return;
        const cleanName = name.trim().toLowerCase();
        const savedData = await AsyncStorage.getItem(`@kawaii_${cleanName}`);
        if (savedData) {
          const parsed = JSON.parse(savedData);
          setInventory(parsed.inventory || []);
          setTotalSessions(parsed.totalSessions || 0);
        } else {
          setInventory([]);
          setTotalSessions(0);
        }
        setCurrentUser(cleanName);
        setScreen('home');
      };

      // Breathing logic
      const runCycle = useCallback((b, p) => {
        const steps = ["Breathe In...", "Hold...", "Breathe Out...", "Rest..."];
        const pattern = [{ v: 1, d: 4000 }, { v: 1, d: 2000 }, { v: 0.1, d: 6000 }, { v: 0.1, d: 2000 }];
        setBreathText(steps[p]);
        Animated.timing(breathAnim, { toValue: pattern[p].v, duration: pattern[p].d, useNativeDriver: false }).start(() => {
          if (p < 3) runCycle(b, p + 1);
          else if (b < 1) runCycle(b + 1, 0); 
          else setScreen('journalAfter');
        });
      }, [breathAnim]);

      // Alternating Reward/Mission Logic
      const handleCoinFlip = async () => {
        const lastEntry = inventory.length > 0 ? inventory[0].type : null;
        const giveMission = lastEntry === 'reward';

        if (giveMission) {
          setCurrentMission(MICRO_MISSIONS[Math.floor(Math.random() * MICRO_MISSIONS.length)]);
          setScreen('missionScreen');
        } else {
          const prize = REWARDS_POOL[Math.floor(Math.random() * REWARDS_POOL.length)];
          setCurrentReward(prize);
          setCurrentAffirmation(AFFIRMATIONS[Math.floor(Math.random() * AFFIRMATIONS.length)]);
          
          const entry = { ...prize, type: 'reward', before: beforeMood, after: afterMood, date: new Date().toLocaleDateString(), timestamp: Date.now() };
          const newInv = [entry, ...inventory];
          const newTotal = totalSessions + 1;
          
          setInventory(newInv);
          setTotalSessions(newTotal);
          await saveUserProgress(currentUser, newInv, newTotal);
          setScreen('rewardReveal');
        }
      };

      const saveMission = async () => {
        const entry = { emoji: "üèÖ", name: "Mindfulness Medal", message: currentMission.task, userReflection: reflectionText, type: 'mission', before: beforeMood, after: afterMood, date: new Date().toLocaleDateString(), timestamp: Date.now() };
        const newInv = [entry, ...inventory];
        const newTotal = totalSessions + 1;
        setInventory(newInv);
        setTotalSessions(newTotal);
        await saveUserProgress(currentUser, newInv, newTotal);
        setReflectionText("");
        setScreen('home');
      };

      return (
        <View style={styles.container}>
          {/* Backgrounds */}
          <View style={StyleSheet.absoluteFill}>
            {selectedScene.id === 'night' ? (
              <View style={[styles.full, {backgroundColor: '#0A192F'}]}>{[...Array(30)].map((_, i) => <TwinkleStar key={i} />)}</View>
            ) : (
              <View style={[styles.full, {backgroundColor: selectedScene.id === 'garden' ? '#E2F0CB' : '#B2E2F2'}]} />
            )}
          </View>

          <SafeAreaView style={styles.full}>
            {screen === 'login' && (
              <View style={[styles.center, {backgroundColor: 'rgba(255,255,255,0.95)'}]}>
                <Text style={styles.title}>Kawaii Calm</Text>
                <TextInput style={styles.inputLarge} placeholder="Student Name" onChangeText={setCurrentUser} value={currentUser} />
                <TouchableOpacity style={[styles.mainBtn, {backgroundColor: '#B2CEFE'}]} onPress={() => loginUser(currentUser)}>
                  <Text style={styles.btnText}>Enter Sanctuary</Text>
                </TouchableOpacity>
              </View>
            )}

            {screen === 'home' && (
              <View style={[styles.center, {backgroundColor: 'rgba(253, 252, 240, 0.9)'}]}>
                <Text style={styles.userTag}>Hello, {currentUser} ‚ú®</Text>
                {['Garden', 'Beach', 'Night'].map((loc) => (
                  <TouchableOpacity key={loc} style={[styles.sceneCard, { borderColor: loc === 'Garden' ? '#FFB7B2' : loc === 'Beach' ? '#B2CEFE' : '#4A90E2' }]} 
                    onPress={() => { 
                      setSelectedScene({id: loc.toLowerCase(), themeColor: loc === 'Garden' ? '#FFB7B2' : loc === 'Beach' ? '#B2CEFE' : '#4A90E2'}); 
                      setScreen('journalBefore'); 
                    }}>
                    <Text style={styles.sceneEmoji}>{loc === 'Garden' ? 'üå∏' : loc === 'Beach' ? 'üèñÔ∏è' : 'üåå'}</Text>
                    <Text style={styles.sceneName}>{loc} Sanctuary</Text>
                  </TouchableOpacity>
                ))}
                <TouchableOpacity onPress={() => setScreen('zenJournal')} style={{marginTop: 20}}>
                    <Text style={{color: '#4A90E2', fontWeight: 'bold'}}>üìñ View Zen Journal</Text>
                </TouchableOpacity>
                <TouchableOpacity onPress={() => setScreen('login')} style={{marginTop: 15}}>
                    <Text style={{color: '#999'}}>Switch Student</Text>
                </TouchableOpacity>
              </View>
            )}

            {screen === 'journalBefore' && (
              <View style={styles.center}><View style={styles.glassCard}>
                <Text style={styles.subtitle}>Current Feeling:</Text>
                <View style={styles.pillContainer}>{SUGGESTED_BEFORE.map(mood => (
                    <TouchableOpacity key={mood} style={[styles.pill, beforeMood === mood && {backgroundColor: selectedScene.themeColor}]} onPress={() => setBeforeMood(mood)}>
                        <Text style={[styles.pillText, beforeMood === mood && {color: 'white'}]}>{mood}</Text>
                    </TouchableOpacity>
                ))}</View>
                <TextInput style={styles.input} placeholder="Or type here..." value={beforeMood} onChangeText={setBeforeMood} />
                <TouchableOpacity style={[styles.mainBtn, {backgroundColor: selectedScene.themeColor}]} onPress={() => {setScreen('breathing'); runCycle(0,0);}}>
                    <Text style={styles.btnText}>Start Breath</Text>
                </TouchableOpacity>
              </View></View>
            )}

            {screen === 'breathing' && (
              <View style={styles.darkOverlay}>
                <Text style={styles.breathInstructionText}>{breathText}</Text>
                <View style={styles.breathContainer}>
                    <View style={[styles.stationaryTargetCircle, { borderColor: selectedScene.themeColor }]} />
                    <Animated.View style={[styles.breathCircle, { transform: [{ scale: breathAnim }], backgroundColor: selectedScene.themeColor }]} />
                </View>
              </View>
            )}

            {screen === 'journalAfter' && (
              <View style={styles.center}><View style={styles.glassCard}>
                <Text style={styles.subtitle}>Feeling now:</Text>
                <View style={styles.pillContainer}>{SUGGESTED_AFTER.map(mood => (
                    <TouchableOpacity key={mood} style={[styles.pill, afterMood === mood && {backgroundColor: selectedScene.themeColor}]} onPress={() => setAfterMood(mood)}>
                        <Text style={[styles.pillText, afterMood === mood && {color: 'white'}]}>{mood}</Text>
                    </TouchableOpacity>
                ))}</View>
                <TouchableOpacity style={[styles.mainBtn, {backgroundColor: selectedScene.themeColor}]} onPress={handleCoinFlip}>
                    <Text style={styles.btnText}>Check Results</Text>
                </TouchableOpacity>
              </View></View>
            )}

            {screen === 'missionScreen' && (
              <View style={styles.center}><View style={styles.whiteCard}>
                <Text style={{color: '#4CAF50', fontWeight: 'bold', marginBottom: 10}}>üßò MICROMISSION</Text>
                <Text style={styles.missionTask}>{currentMission?.task}</Text>
                <Text style={styles.subtitle}>{currentMission?.question}</Text>
                <TextInput style={styles.input} placeholder="Your answer..." value={reflectionText} onChangeText={setReflectionText} />
                <TouchableOpacity style={[styles.mainBtn, {backgroundColor: '#4CAF50'}]} onPress={saveMission}>
                    <Text style={styles.btnText}>Done</Text>
                </TouchableOpacity>
              </View></View>
            )}

            {screen === 'rewardReveal' && (
              <View style={styles.center}><View style={styles.whiteCard}>
                <Text style={styles.affirmationText}>‚ú® {currentAffirmation}</Text>
                <Text style={{fontSize: 80}}>{currentReward?.emoji}</Text>
                <Text style={styles.title}>{currentReward?.name}</Text>
                <TouchableOpacity style={[styles.mainBtn, {backgroundColor: selectedScene.themeColor}]} onPress={() => setScreen('sereneScene')}>
                    <Text style={styles.btnText}>Go to Collection</Text>
                </TouchableOpacity>
              </View></View>
            )}

            {screen === 'sereneScene' && (
              <View style={styles.full}>
                <View style={styles.masterBubbleContainer}>
                    <View style={[styles.masterBubble, { borderColor: selectedScene.themeColor }]}>
                        <Text style={styles.masterBubbleText}>{activeMessage}</Text>
                    </View>
                </View>
                <ScrollView contentContainerStyle={styles.grid}>
                    {inventory.map((item, i) => <PoppingItem key={i} item={item} onTouch={setActiveMessage} />)}
                </ScrollView>
                <TouchableOpacity style={[styles.backBtn, {backgroundColor: selectedScene.themeColor}]} onPress={() => setScreen('home')}>
                    <Text style={styles.btnText}>Finish</Text>
                </TouchableOpacity>
              </View>
            )}

            {screen === 'zenJournal' && (
              <View style={[styles.full, {backgroundColor: '#FFF'}]}>
                 <Text style={[styles.title, {textAlign: 'center', marginTop: 40}]}>Zen Journal</Text>
                 <ScrollView style={{padding: 20}}>
                    {inventory.map((item, i) => (
                        <View key={i} style={styles.journalEntry}>
                            <Text style={{fontSize: 32, marginRight: 15}}>{item.emoji}</Text>
                            <View style={{flex:1}}>
                                <Text style={{fontWeight: 'bold'}}>{item.name} ({item.date})</Text>
                                <Text style={{fontSize: 12, color: '#888'}}>{item.before} ‚ûî {item.after}</Text>
                                <Text style={{fontStyle: 'italic', color: '#666'}}>"{item.message}"</Text>
                                {item.userReflection ? <Text style={{color: '#4CAF50'}}>Note: {item.userReflection}</Text> : null}
                            </View>
                        </View>
                    ))}
                 </ScrollView>
                 <TouchableOpacity style={[styles.mainBtn, {backgroundColor: '#444', margin: 20, alignSelf: 'center'}]} onPress={() => setScreen('home')}>
                    <Text style={styles.btnText}>Back</Text>
                </TouchableOpacity>
              </View>
            )}
          </SafeAreaView>
        </View>
      );
    }

    const styles = StyleSheet.create({
      container: { flex: 1 },
      full: { flex: 1 },
      center: { flex: 1, justifyContent: 'center', alignItems: 'center', padding: 20 },
      star: { position: 'absolute', backgroundColor: 'white', width: 2, height: 2, borderRadius: 1 },
      title: { fontSize: 32, fontWeight: 'bold', color: '#444', marginBottom: 15 },
      userTag: { backgroundColor: '#FFF', paddingHorizontal: 15, paddingVertical: 5, borderRadius: 15, fontWeight: 'bold', marginBottom: 20 },
      sceneCard: { width: '80%', backgroundColor: 'white', padding: 15, borderRadius: 20, marginBottom: 10, flexDirection: 'row', alignItems: 'center', border: '2px solid' },
      sceneEmoji: { fontSize: 30, marginRight: 15 },
      sceneName: { fontSize: 18, fontWeight: 'bold' },
      glassCard: { backgroundColor: 'rgba(255,255,255,0.9)', padding: 20, borderRadius: 25, width: '85%', alignItems: 'center' },
      subtitle: { fontSize: 18, color: '#666', marginBottom: 10 },
      pillContainer: { flexDirection: 'row', flexWrap: 'wrap', justifyContent: 'center', marginBottom: 10 },
      pill: { backgroundColor: '#EEE', paddingHorizontal: 12, paddingVertical: 6, borderRadius: 15, margin: 4 },
      pillText: { fontSize: 13, fontWeight: '600' },
      input: { width: '100%', padding: 12, borderRadius: 10, border: '1px solid #DDD', marginBottom: 15 },
      inputLarge: { width: '80%', padding: 15, fontSize: 20, textAlign: 'center', borderRadius: 15, border: '1px solid #DDD', marginBottom: 20 },
      mainBtn: { paddingVertical: 12, paddingHorizontal: 30, borderRadius: 25 },
      btnText: { color: 'white', fontWeight: 'bold' },
      darkOverlay: { flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.7)' },
      breathInstructionText: { color: 'white', fontSize: 28, fontWeight: 'bold', marginBottom: 30 },
      breathContainer: { width: 200, height: 200, justifyContent: 'center', alignItems: 'center' },
      stationaryTargetCircle: { position: 'absolute', width: 180, height: 180, borderRadius: 90, border: '3px solid', opacity: 0.3 },
      breathCircle: { width: 180, height: 180, borderRadius: 90 },
      whiteCard: { backgroundColor: 'white', padding: 25, borderRadius: 25, alignItems: 'center', width: '85%' },
      missionTask: { fontSize: 20, fontWeight: 'bold', textAlign: 'center', marginBottom: 15 },
      masterBubbleContainer: { paddingTop: 50, alignItems: 'center' },
      masterBubble: { backgroundColor: 'white', padding: 15, borderRadius: 20, width: '80%', border: '2px solid' },
      masterBubbleText: { textAlign: 'center', fontSize: 14 },
      grid: { flexDirection: 'row', flexWrap: 'wrap', justifyContent: 'center', padding: 20 },
      itemContainer: { width: 80, height: 80, margin: 5, justifyContent: 'center', alignItems: 'center' },
      popCircle: { position: 'absolute', width: 70, height: 70, borderRadius: 35, backgroundColor: 'rgba(255,255,255,0.3)', border: '1px solid #FFF' },
      rewardText: { fontSize: 35 },
      backBtn: { position: 'absolute', bottom: 30, alignSelf: 'center', paddingVertical: 12, paddingHorizontal: 40, borderRadius: 25 },
      journalEntry: { flexDirection: 'row', padding: 15, borderBottom: '1px solid #EEE' }
    });

    const root = ReactDOM.createRoot(document.getElementById('app-root'));
    root.render(<App />);
  </script>
</body>
</html>
