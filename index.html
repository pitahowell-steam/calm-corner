<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kawaii Calm Sanctuary</title>
    <style>
        :root { --soft-pink: #FFB7B2; --soft-blue: #B2CEFE; --night-blue: #0A192F; --text-dark: #444; --glass: rgba(255, 255, 255, 0.96); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, sans-serif; overflow: hidden; background: #FDFCF0; color: var(--text-dark); }
        
        .bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background-size: cover; background-position: center; transition: all 1.2s ease; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.8; animation: twinkle 2s infinite alternate; z-index: 2; }
        @keyframes twinkle { from { opacity: 0.2; } to { opacity: 1; } }
        
        .screen { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; justify-content: center; position: absolute; z-index: 10; padding: 20px; background: transparent; }
        .active { display: flex; }
        
        .glass-card { background: var(--glass); padding: 30px; border-radius: 35px; width: 100%; max-width: 420px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.07); border: 1px solid rgba(255,255,255,0.3); }
        .scene-card { background: white; width: 100%; padding: 18px; border-radius: 20px; margin-bottom: 12px; border: 3px solid #F0F0F0; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-weight: bold; }
        
        .pill-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 15px 0; }
        .pill { background: #F5F5F5; padding: 10px 18px; border-radius: 20px; font-weight: 600; color: #777; cursor: pointer; border: 2px solid transparent; }
        
        input, textarea { width: 100%; padding: 15px; border: 2px solid #EEE; border-radius: 18px; font-size: 16px; margin: 10px 0; outline: none; background: #FAFAFA; font-family: inherit; }
        .main-btn { color: white; padding: 16px 45px; border-radius: 35px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; }

        #breath-screen { background: rgba(0, 0, 0, 0.15) !important; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 100; }
        #breath-text { color: white; font-size: 34px; font-weight: bold; text-shadow: 0 4px 10px rgba(0,0,0,0.3); text-align: center; margin-bottom: 40px; }
        
        #breath-container { position: relative; flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        
        #target-circle { position: absolute; width: 100px; height: 100px; border-radius: 50%; border: 3px solid white; background: rgba(255, 255, 255, 0.05); transform: scale(2.6); z-index: 50; transition: border-color 0.5s; opacity: 0.4; }
        
        #breath-circle { width: 100px; height: 100px; border-radius: 50%; z-index: 60; transform: scale(1); will-change: transform; box-shadow: 0 0 20px rgba(255,255,255,0.4); animation: glow-pulse 2s infinite ease-in-out; }

        @keyframes glow-pulse { 0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.2); } 50% { box-shadow: 0 0 40px rgba(255,255,255,0.6); } }

        .journal-list { width: 100%; max-width: 450px; overflow-y: auto; flex: 1; padding: 10px; }
        .journal-card { background: white; padding: 20px; border-radius: 25px; margin-bottom: 15px; display: flex; gap: 15px; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #EEE; text-align: left;}
        .mood-tag { font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; }
        .reflection-box { 
            background: #f8f9fa; /* Very light gray */
            padding: 12px; 
            border-radius: 12px; 
            font-size: 13px; 
            margin-top: 10px; 
            color: #444; 
            border: 1px solid #e0e0e0; 
            font-style: italic;
            width: 100%;           /* Fill the card */
            box-sizing: border-box; /* IMPORTANT: Keeps padding inside the width */
            display: block;        /* Ensures it stays on its own line */
            clear: both;           /* Prevents floating elements from pushing it */
        }
    </style>
</head>
<body>

    <div id="bg-layer" class="bg-layer"></div>

    <div id="login-screen" class="screen active">
        <div class="glass-card">
            <h1>‚ú® Kawaii Calm</h1>
            <p style="color: #888;">Welcome to your safe space.</p>
            <input type="text" id="name-input" placeholder="Enter Name..." autocomplete="off">
            <button class="main-btn" id="login-trigger" style="background: var(--soft-blue);">Enter Sanctuary</button>
        </div>
    </div>

    <div id="home-screen" class="screen">
        <div class="glass-card">
            <h2 style="margin:0;">Hi, <span id="user-display"></span>!</h2>
            <p style="font-weight: bold; color: #888;">üèÜ Points: <span id="points-display">0</span></p>
            <div class="scene-card" style="border-color: var(--soft-pink);" onclick="setTheme('garden')">üå∏ Garden</div>
            <div class="scene-card" style="border-color: var(--soft-blue);" onclick="setTheme('beach')">üèñÔ∏è Beach</div>
            <div class="scene-card" style="border-color: #4A90E2;" onclick="setTheme('night')">üåå Night</div>
            <button style="margin-top:15px; background:none; border:none; color: #4A90E2; font-weight:bold; cursor:pointer;" onclick="showJournal()">üìñ View Journey</button>
            <br>
            <button style="margin-top:10px; background:none; border:none; color:#CCC; cursor:pointer; font-size:12px;" onclick="location.reload()">Switch User</button>
        </div>
    </div>

    <div id="before-screen" class="screen">
        <div class="glass-card">
            <h2>How do you feel?</h2>
            <div id="before-pills" class="pill-container"></div>
            <input type="text" id="before-custom" placeholder="Or describe it here...">
            <button id="start-btn" class="main-btn" onclick="startBreath()">Start Breathing</button>
        </div>
    </div>

    <div id="breath-screen" class="screen">
        <h1 id="breath-text">Ready?</h1>
        <div id="breath-container">
            <div id="target-circle"></div>
            <div id="breath-circle"></div>
        </div>
    </div>

    <div id="after-screen" class="screen">
        <div class="glass-card">
            <h2>Feeling better?</h2>
            <div id="after-pills" class="pill-container"></div>
            <input type="text" id="after-custom" placeholder="I feel...">
            <button id="finish-btn" class="main-btn" onclick="handleLogic()">Complete Session</button>
        </div>
    </div>

    <div id="reward-screen" class="screen">
        <div class="glass-card" id="reward-content"></div>
    </div>

    <div id="journal-screen" class="screen" style="background: #F9FAFB;">
        <h2 style="margin-bottom: 5px;">Journal</h2>
        <div id="journal-list" class="journal-list"></div>
        <button class="main-btn" style="background: #444; width: 200px; margin: 20px;" onclick="showScreen('home-screen')">Back Home</button>
    </div>

    <script>
        const SUGGESTED_BEFORE = ["Overwhelmed", "Frustrated", "Tense", "Stressed", "Sad"];
        const SUGGESTED_AFTER = ["Steady", "Relaxed", "Better", "Focused", "Stronger"];
        const MISSIONS = [
            { task: "Find 3 blue things in the room.", q: "What did you see?" },
            { task: "Press your feet into the floor.", q: "How does it feel? (Hard, soft?)" },
            { task: "Look for something shaped like a circle.", q: "What object did you find?" }
        ];
        const REWARDS = [
            { emoji: "üê¢", name: "Patience Turtle", msg: "Slow and steady is a superpower." },
            { emoji: "üê±", name: "Lucky Cat", msg: "A friend for your peaceful moments." },
            { emoji: "‚òÄÔ∏è", name: "Golden Sun", msg: "Your energy lights up the room." },
            { emoji: "‚òÅÔ∏è", name: "Happy Cloud", msg: "Bad feelings pass just like clouds." }
        ];

        let currentUser = "";
        let inventory = [];
        let totalSessions = 0;
        let selectedTheme = { color: '#B2CEFE' };

        const loginBtn = document.getElementById('login-trigger');
        const nameInput = document.getElementById('name-input');

        function performLogin() {
            const name = nameInput.value.trim().toLowerCase();
            if(!name) return;
            currentUser = name;
            const saved = localStorage.getItem('@kawaii_' + currentUser);
            const data = saved ? JSON.parse(saved) : { inventory: [], total: 0 };
            inventory = data.inventory || [];
            totalSessions = data.total || 0;
            document.getElementById('user-display').innerText = currentUser;
            document.getElementById('points-display').innerText = totalSessions;
            showScreen('home-screen');
        }

        loginBtn.onclick = performLogin;
        nameInput.onkeypress = (e) => { if(e.key === 'Enter') performLogin(); };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function setTheme(theme) {
            const bg = document.getElementById('bg-layer');
            bg.innerHTML = '';
            if(theme === 'garden') {
                selectedTheme.color = '#FFB7B2';
                bg.style.background = "url('https://images.unsplash.com/photo-1528459801416-a9e53bbf4e17?q=80&w=500') center/cover";
            } else if(theme === 'beach') {
                selectedTheme.color = '#B2CEFE';
                bg.style.background = "url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=500') center/cover";
            } else {
                selectedTheme.color = '#4A90E2';
                bg.style.background = "#0A192F";
                for(let i=0; i<35; i++) {
                    let s = document.createElement('div'); s.className = 'star';
                    s.style.width = s.style.height = Math.random()*3+'px';
                    s.style.top = Math.random()*100+'%'; s.style.left = Math.random()*100+'%';
                    bg.appendChild(s);
                }
            }
            setupPills();
            showScreen('before-screen');
        }

        function setupPills() {
            document.getElementById('before-pills').innerHTML = SUGGESTED_BEFORE.map(m => `<div class="pill" onclick="selPill(this, 'before')">${m}</div>`).join('');
            document.getElementById('after-pills').innerHTML = SUGGESTED_AFTER.map(m => `<div class="pill" onclick="selPill(this, 'after')">${m}</div>`).join('');
            document.getElementById('start-btn').style.background = selectedTheme.color;
            document.getElementById('finish-btn').style.background = selectedTheme.color;
        }

        function selPill(el, type) {
            el.parentElement.querySelectorAll('.pill').forEach(p => { p.style.background = '#F5F5F5'; p.style.borderColor = 'transparent'; });
            el.style.background = 'white'; el.style.borderColor = selectedTheme.color;
            document.getElementById(type + '-custom').value = el.innerText;
        }

       function startBreath() {
        showScreen('breath-screen');
        const circle = document.getElementById('breath-circle');
        const target = document.getElementById('target-circle');
        const txt = document.getElementById('breath-text');
        
        // 1. THE RESET: Force the circle to be small instantly
        circle.style.transition = "none"; 
        circle.style.transform = "scale(0.4)"; 
        
        // Apply theme colors
        circle.style.backgroundColor = selectedTheme.color;
        target.style.borderColor = selectedTheme.color;
        target.style.opacity = "0.4";
    
        const patterns = [
            {t: "In...", s: 2.6, d: 4000}, 
            {t: "Hold", s: 2.6, d: 2000}, 
            {t: "Out...", s: 0.4, d: 6000}, 
            {t: "Rest", s: 0.4, d: 2000}
        ];
        let step = 0;
        let cycle = 1;
    
        function next() {
            if (step >= patterns.length) {
                if (cycle < 3) { 
                    cycle++; 
                    step = 0; 
                } else { 
                    showScreen('after-screen'); 
                    return; 
                }
            }

        txt.innerHTML = `${patterns[step].t}<br><small style="font-size:14px; opacity:0.6">Round ${cycle}/3</small>`;
        
        // 2. THE ANIMATION: Re-enable transitions and move to next size
        circle.style.transition = `transform ${patterns[step].d}ms ease-in-out`;
        circle.style.transform = `scale(${patterns[step].s})`;

        setTimeout(() => { 
            step++; 
            next(); 
        }, patterns[step].d);
    }

    // 3. THE KICKSTART: This 100ms delay prevents the "Starting Large" bug
    setTimeout(next, 100);
}
        function handleLogic() {
            const beforeMood = document.getElementById('before-custom').value || "Okay";
            const afterMood = document.getElementById('after-custom').value || "Better";
            const content = document.getElementById('reward-content');
            const isMission = Math.random() > 0.5;
            totalSessions++;

            if(isMission) {
                const m = MISSIONS[Math.floor(Math.random()*MISSIONS.length)];
                content.innerHTML = `
                    <p style="color:#4CAF50; font-weight:bold;">üßò GROUNDING MISSION</p>
                    <h2>${m.task}</h2><p>${m.q}</p>
                    <textarea id="mission-refl" placeholder="Type what you found..."></textarea>
                    <button class="main-btn" style="background:#4CAF50" onclick="saveMission('${m.task}', '${beforeMood}', '${afterMood}')">Save Mission</button>
                `;
            } else {
                const r = REWARDS[Math.floor(Math.random()*REWARDS.length)];
                inventory.unshift({ emoji: r.emoji, name: r.name, msg: r.msg, before: beforeMood, after: afterMood, date: new Date().toLocaleDateString() });
                content.innerHTML = `
                    <div style="font-size:80px;">${r.emoji}</div>
                    <h2>${r.name}</h2><p>"${r.msg}"</p>
                    <button class="main-btn" style="background:${selectedTheme.color}" onclick="showScreen('home-screen')">Collect Reward</button>
                `;
            }
            saveData();
            showScreen('reward-screen');
        }

        function saveMission(task, before, after) {
            const refl = document.getElementById('mission-refl').value || "No response recorded.";
            inventory.unshift({ 
                emoji: 'üèÖ', 
                name: 'Mission Medal', 
                msg: task,          // This is the mission question
                reflection: refl,   // This is the student's typed answer
                before: before, 
                after: after, 
                date: new Date().toLocaleDateString() 
            });
            saveData();
            showScreen('home-screen');
        }
        function saveData() {
            localStorage.setItem('@kawaii_' + currentUser, JSON.stringify({inventory, total: totalSessions}));
            const d = document.getElementById('points-display');
            if(d) d.innerText = totalSessions;
        }

        function showJournal() {
    const list = document.getElementById('journal-list');
    
    list.innerHTML = inventory.length === 0 ? "<p>No entries yet!</p>" : inventory.map(i => {
        const entryText = i.msg || i.reflection || "No details recorded";
        const entryTitle = i.name || (i.emoji === 'üèÖ' ? "Mission Medal" : "Entry");

        return `
            <div class="journal-card" style="display: flex; gap: 15px; align-items: flex-start;">
                <div style="font-size:35px; min-width: 45px; text-align: center;">${i.emoji}</div>
                
                <div style="flex: 1; min-width: 0;"> 
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span class="mood-tag">${i.date}</span>
                        <span style="font-size:11px; color:${selectedTheme.color}; font-weight:bold;">
                            ${i.before || '...'} ‚ûî ${i.after || '...'}
                        </span>
                    </div>
                    <div style="font-weight:bold; font-size: 15px;">${entryTitle}</div>
                    <div style="font-size: 13px; color:#666; line-height: 1.4;">${entryText}</div>
                    
                    ${i.reflection ? `
                        <div class="reflection-box">
                            <span style="font-weight:bold; color:#888; font-size:10px; text-transform:uppercase;">My Response:</span><br>
                            "${i.reflection}"
                        </div>` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    showScreen('journal-screen');
    }
    </script>
</body>
</html>
