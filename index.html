<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kawaii Calm - PGCPS Sanctuary</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://unpkg.com/react-native-web@0.19.6/dist/bundle.js"></script>

  <style>
    html, body, #app-root { height: 100%; width: 100%; overflow: hidden; margin: 0; padding: 0; font-family: -apple-system, system-ui, sans-serif; background-color: #FDFCF0; }
    #app-root { display: flex; }
    .loading-screen { display: flex; justify-content: center; align-items: center; height: 100vh; width: 100%; font-size: 20px; color: #888; }
  </style>
</head>
<body>
  <div id="app-root">
    <div class="loading-screen">‚ú® Loading Sanctuary... (Check Wi-Fi if this stays)</div>
  </div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;
    const { Text, View, StyleSheet, TouchableOpacity, Animated, SafeAreaView, ScrollView, TextInput, Dimensions } = ReactNative;

    const { width, height } = Dimensions.get('window');

    const AsyncStorage = {
      getItem: async (key) => window.localStorage.getItem(key),
      setItem: async (key, val) => window.localStorage.setItem(key, val),
    };

    const SUGGESTED_BEFORE = ["Overwhelmed", "Disrespected", "Drained", "Hyped", "Stressed", "Frustrated"];
    const SUGGESTED_AFTER = ["Steady", "Stronger", "Relaxed", "Focused", "Better", "In Control"];
    const MICRO_MISSIONS = [
      { task: "Find 3 blue things in the room.", question: "What 3 blue things did you find?" },
      { task: "Notice your feet on the floor.", question: "Did the floor feel solid, cold, or warm?" },
      { task: "Identify one sound outside.", question: "What was the sound?" },
      { task: "Drop your shoulders heavy.", question: "How does it feel when the tension melted?" },
      { task: "Look left, then right.", question: "What is one tiny detail you never noticed before?" }
    ];
    const REWARDS_POOL = [
      { id: 1, emoji: "üê¢", name: "Patience Turtle", message: "Slow and steady is a superpower." },
      { id: 2, emoji: "üê±", name: "Lucky Cat", message: "A friend to watch over your peace." },
      { id: 3, emoji: "üëü", name: "Running Shoes", message: "Moving helps clear your mind." },
      { id: 4, emoji: "‚òÄÔ∏è", name: "Golden Sun", message: "Light and fresh air can reset your mood." },
      { id: 5, emoji: "üìì", name: "Zen Journal", message: "Writing it down makes it easier to let go." }
    ];
    const AFFIRMATIONS = ["I am proud of you.", "You gave your brain a break.", "One breath at a time.", "You are in control."];

    const TwinkleStar = () => {
      const opacity = useRef(new Animated.Value(Math.random())).current;
      const [pos] = useState({ top: Math.random() * height, left: Math.random() * width });
      useEffect(() => {
        const twinkle = () => {
          Animated.sequence([
            Animated.timing(opacity, { toValue: 0.2, duration: Math.random() * 2000 + 1000, useNativeDriver: false }),
            Animated.timing(opacity, { toValue: 1, duration: 1500, useNativeDriver: false }),
          ]).start(() => twinkle());
        };
        twinkle();
      }, []);
      return <Animated.View style={[styles.star, { top: pos.top, left: pos.left, opacity }]} />;
    };

    const PoppingItem = ({ item, onTouch }) => {
      const opacity = useRef(new Animated.Value(1)).current;
      const scale = useRef(new Animated.Value(1)).current;
      const handlePop = () => {
        onTouch(item.message);
        Animated.parallel([
          Animated.timing(opacity, { toValue: 0, duration: 150, useNativeDriver: false }),
          Animated.timing(scale, { toValue: 1.6, duration: 150, useNativeDriver: false })
        ]).start(() => {
          setTimeout(() => {
            scale.setValue(0);
            Animated.parallel([
              Animated.timing(opacity, { toValue: 1, duration: 400, useNativeDriver: false }),
              Animated.spring(scale, { toValue: 1, friction: 6, useNativeDriver: false })
            ]).start();
          }, 1200);
        });
      };
      return (
        <TouchableOpacity onPress={handlePop} activeOpacity={0.8}>
          <View style={styles.itemContainer}>
            <Animated.View style={[styles.popCircle, { opacity, transform: [{ scale }] }]} />
            <Text style={styles.rewardText}>{item.emoji}</Text>
          </View>
        </TouchableOpacity>
      );
    };

    function App() {
      const [screen, setScreen] = useState('login'); 
      const [currentUser, setCurrentUser] = useState('');
      const [selectedScene, setSelectedScene] = useState({ id: 'garden', themeColor: '#FFB7B2' });
      const [inventory, setInventory] = useState([]);
      const [currentReward, setCurrentReward] = useState(null);
      const [currentMission, setCurrentMission] = useState(null);
      const [reflectionText, setReflectionText] = useState("");
      const [breathText, setBreathText] = useState("");
      const breathAnim = useRef(new Animated.Value(0.1)).current;
      const [beforeMood, setBeforeMood] = useState("");
      const [afterMood, setAfterMood] = useState("");
      const [activeMessage, setActiveMessage] = useState("Tap items to ground yourself...");

      const loginUser = async (name) => {
        if (!name.trim()) return;
        const cleanName = name.trim().toLowerCase();
        const savedData = await AsyncStorage.getItem(`@kawaii_${cleanName}`);
        if (savedData) {
          const parsed = JSON.parse(savedData);
          setInventory(parsed.inventory || []);
        } else {
          setInventory([]);
        }
        setCurrentUser(cleanName);
        setScreen('home');
      };

      const runCycle = useCallback((b, p) => {
        const steps = ["Breathe In...", "Hold...", "Breathe Out...", "Rest..."];
        const pattern = [{ v: 1, d: 4000 }, { v: 1, d: 2000 }, { v: 0.1, d: 6000 }, { v: 0.1, d: 2000 }];
        setBreathText(steps[p]);
        Animated.timing(breathAnim, { toValue: pattern[p].v, duration: pattern[p].d, useNativeDriver: false }).start(() => {
          if (p < 3) runCycle(b, p + 1);
          else if (b < 1) runCycle(b + 1, 0); 
          else setScreen('journalAfter');
        });
      }, [breathAnim]);

      const handleCoinFlip = async () => {
        const lastType = inventory.length > 0 ? inventory[0].type : 'mission';
        if (lastType === 'reward') {
          setCurrentMission(MICRO_MISSIONS[Math.floor(Math.random() * MICRO_MISSIONS.length)]);
          setScreen('missionScreen');
        } else {
          const prize = REWARDS_POOL[Math.floor(Math.random() * REWARDS_POOL.length)];
          const entry = { ...prize, type: 'reward', before: beforeMood, after: afterMood, date: new Date().toLocaleDateString() };
          const newInv = [entry, ...inventory];
          setInventory(newInv);
          await AsyncStorage.setItem(`@kawaii_${currentUser}`, JSON.stringify({ inventory: newInv }));
          setCurrentReward(prize);
          setScreen('rewardReveal');
        }
      };

      return (
        <View style={styles.container}>
          <View style={StyleSheet.absoluteFill}>
            {selectedScene.id === 'night' ? (
              <View style={[styles.full, {backgroundColor: '#0A192F'}]}>{[...Array(20)].map((_, i) => <TwinkleStar key={i} />)}</View>
            ) : (
              <View style={[styles.full, {backgroundColor: selectedScene.id === 'garden' ? '#E2F0CB' : '#B2E2F2'}]} />
            )}
          </View>

          <SafeAreaView style={styles.full}>
            {screen === 'login' && (
              <View style={[styles.center, {backgroundColor: 'white'}]}>
                <Text style={styles.title}>Kawaii Calm</Text>
                <TextInput style={styles.input} placeholder="Student Name" onChangeText={setCurrentUser} />
                <TouchableOpacity style={styles.mainBtn} onPress={() => loginUser(currentUser)}>
                  <Text style={styles.btnText}>Enter</Text>
                </TouchableOpacity>
              </View>
            )}

            {screen === 'home' && (
              <View style={styles.center}>
                <Text style={styles.userTag}>Welcome, {currentUser} ‚ú®</Text>
                {['Garden', 'Beach', 'Night'].map((loc) => (
                  <TouchableOpacity key={loc} style={[styles.sceneCard, { borderColor: loc === 'Garden' ? '#FFB7B2' : '#4A90E2' }]} 
                    onPress={() => { setSelectedScene({id: loc.toLowerCase(), themeColor: '#4A90E2'}); setScreen('journalBefore'); }}>
                    <Text style={styles.sceneEmoji}>{loc === 'Garden' ? 'üå∏' : 'üèñÔ∏è'}</Text>
                    <Text style={styles.sceneName}>{loc} Sanctuary</Text>
                  </TouchableOpacity>
                ))}
                <TouchableOpacity onPress={() => setScreen('zenJournal')} style={{marginTop: 20}}>
                    <Text style={{color: '#4A90E2', fontWeight: 'bold'}}>üìñ View Zen Journal</Text>
                </TouchableOpacity>
              </View>
            )}

            {screen === 'journalBefore' && (
              <View style={styles.center}><View style={styles.whiteCard}>
                <Text style={styles.subtitle}>Current Feeling:</Text>
                <View style={styles.pillContainer}>{SUGGESTED_BEFORE.map(mood => (
                    <TouchableOpacity key={mood} style={[styles.pill, beforeMood === mood && {backgroundColor: '#B2CEFE'}]} onPress={() => setBeforeMood(mood)}>
                        <Text>{mood}</Text>
                    </TouchableOpacity>
                ))}</View>
                <TouchableOpacity style={styles.mainBtn} onPress={() => {setScreen('breathing'); runCycle(0,0);}}>
                    <Text style={styles.btnText}>Start Breath</Text>
                </TouchableOpacity>
              </View></View>
            )}

            {screen === 'breathing' && (
              <View style={styles.darkOverlay}>
                <Text style={styles.breathText}>{breathText}</Text>
                <Animated.View style={[styles.breathCircle, { transform: [{ scale: breathAnim }] }]} />
              </View>
            )}

            {screen === 'journalAfter' && (
              <View style={styles.center}><View style={styles.whiteCard}>
                <Text style={styles.subtitle}>Feeling now:</Text>
                <View style={styles.pillContainer}>{SUGGESTED_AFTER.map(mood => (
                    <TouchableOpacity key={mood} style={[styles.pill, afterMood === mood && {backgroundColor: '#B2CEFE'}]} onPress={() => setAfterMood(mood)}>
                        <Text>{mood}</Text>
                    </TouchableOpacity>
                ))}</View>
                <TouchableOpacity style={styles.mainBtn} onPress={handleCoinFlip}>
                    <Text style={styles.btnText}>Results</Text>
                </TouchableOpacity>
              </View></View>
            )}

            {screen === 'rewardReveal' && (
              <View style={styles.center}><View style={styles.whiteCard}>
                <Text style={{fontSize: 80}}>{currentReward?.emoji}</Text>
                <Text style={styles.title}>{currentReward?.name}</Text>
                <TouchableOpacity style={styles.mainBtn} onPress={() => setScreen('sereneScene')}>
                    <Text style={styles.btnText}>Collection</Text>
                </TouchableOpacity>
              </View></View>
            )}

            {screen === 'sereneScene' && (
              <View style={styles.full}>
                <View style={styles.center}><View style={styles.whiteCard}><Text>{activeMessage}</Text></View></View>
                <ScrollView contentContainerStyle={styles.grid}>
                    {inventory.map((item, i) => <PoppingItem key={i} item={item} onTouch={setActiveMessage} />)}
                </ScrollView>
                <TouchableOpacity style={styles.backBtn} onPress={() => setScreen('home')}><Text style={styles.btnText}>Back</Text></TouchableOpacity>
              </View>
            )}

            {screen === 'zenJournal' && (
              <View style={[styles.full, {backgroundColor: 'white'}]}>
                 <Text style={[styles.title, {textAlign: 'center', marginTop: 40}]}>Journal</Text>
                 <ScrollView style={{padding: 20}}>
                    {inventory.map((item, i) => (
                        <View key={i} style={{padding: 10, borderBottomWidth: 1, borderColor: '#EEE'}}>
                            <Text>{item.emoji} {item.name} - {item.date}</Text>
                            <Text style={{fontSize: 12, color: '#888'}}>{item.before} ‚ûî {item.after}</Text>
                        </View>
                    ))}
                 </ScrollView>
                 <TouchableOpacity style={styles.mainBtn} onPress={() => setScreen('home')}><Text style={styles.btnText}>Close</Text></TouchableOpacity>
              </View>
            )}
          </SafeAreaView>
        </View>
      );
    }

    const styles = StyleSheet.create({
      container: { flex: 1 },
      full: { flex: 1 },
      center: { justifyContent: 'center', alignItems: 'center', padding: 20 },
      star: { position: 'absolute', backgroundColor: 'white', width: 2, height: 2, borderRadius: 1 },
      title: { fontSize: 32, fontWeight: 'bold', color: '#444' },
      userTag: { backgroundColor: 'white', padding: 10, borderRadius: 10, marginBottom: 20 },
      sceneCard: { width: '80%', backgroundColor: 'white', padding: 15, borderRadius: 20, marginBottom: 10, flexDirection: 'row', alignItems: 'center', borderWidth: 2 },
      sceneEmoji: { fontSize: 30, marginRight: 15 },
      sceneName: { fontSize: 18, fontWeight: 'bold' },
      whiteCard: { backgroundColor: 'white', padding: 20, borderRadius: 20, width: '90%', alignItems: 'center' },
      subtitle: { fontSize: 18, color: '#666', marginBottom: 10 },
      pillContainer: { flexDirection: 'row', flexWrap: 'wrap', justifyContent: 'center' },
      pill: { backgroundColor: '#EEE', padding: 10, borderRadius: 10, margin: 5 },
      input: { width: '80%', padding: 15, borderRadius: 10, borderWidth: 1, borderColor: '#DDD', marginVertical: 20 },
      mainBtn: { backgroundColor: '#B2CEFE', padding: 15, borderRadius: 25, width: 150, alignItems: 'center', marginVertical: 10, alignSelf: 'center' },
      btnText: { color: 'white', fontWeight: 'bold' },
      darkOverlay: { flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.8)' },
      breathText: { color: 'white', fontSize: 24, marginBottom: 40 },
      breathCircle: { width: 150, height: 150, borderRadius: 75, backgroundColor: '#B2CEFE' },
      grid: { flexDirection: 'row', flexWrap: 'wrap', justifyContent: 'center' },
      itemContainer: { width: 80, height: 80, margin: 5, justifyContent: 'center', alignItems: 'center' },
      popCircle: { position: 'absolute', width: 60, height: 60, borderRadius: 30, backgroundColor: 'rgba(255,255,255,0.5)' },
      rewardText: { fontSize: 30 },
      backBtn: { backgroundColor: '#B2CEFE', padding: 15, borderRadius: 25, alignSelf: 'center', marginBottom: 20 }
    });

    const root = ReactDOM.createRoot(document.getElementById('app-root'));
    root.render(<App />);
  </script>
</body>
</html>
